<!DOCTYPE HTML>
<html lang='en'>

<head>
	<meta charset='utf-8'>
	<!-- <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> -->
	<meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
	<link rel="stylesheet" type="text/css" href="/index.css">

	<meta name="theme-color" content="#dc136c">
	<link rel='manifest' href='/manifest.json'>
	
	<meta name="msapplication-TileColor" content="#ffffff">
	<meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
	<meta name="theme-color" content="#ffffff">
		<title>Hardcore JS</title>

	</head>

	<body >
		<nav>
			<div class='nav-left-block'></div>
			<ul class='nav-items'>
				<li class='nav-item'><a href="/home">Home</a></li>
				<li class='nav-item'><a href="/javascript">Javascript</a></li>
				<li class='nav-item'><a href="/node">Node</a></li>
				<li class='nav-item'><a href="/programming">Programming</a></li>
				<li class='nav-item'><a href="/react">React</a></li>
				<li class='nav-item'><a href="/svelte">Svelte</a></li>
			</ul>
		</nav>

</body><div class="page-wrapper">

<div class='blog-page'>
		<div class="blog-center-container">
			<div class='blog-title-container'>
					<h1 >Building a Line Chart with D3</h1>
					<h4 class='blog-subtitle'>Jack Misteli</h4>
			</div>
			<div class="blog-content-container">
				<div class="blog-content">

				<p><p>If you are using the D3 API for the first time, you are probably a little bit intimidating. A line chart is great project to get your feet in the water ðŸ˜ƒ ðŸ’§. Before we get started make sure you read <a href="/javascript/setting-up-d3">our article about setting up d3 in your project</a>.
</p>


<h1>Choosing our data</h1>
<p><a href="#writing-lines"> I already know how data works: Skip â†“</a><p>
<p>Choosing the right data set is important. We have to make sure that we'll have something that plots well with no crazy edge cases. </p>

<p>I wanted to choose something a bit uplifting in these hard times so I chose some of the happiness data available at <a href="https://ourworldindata.org/happiness-and-life-satisfaction#all-charts-preview" target="_blank">Our World in Data</a>.
 </p>

<p>
Usually when you find data it will be <a href="/programming/what-is-csv.html"> in a CSV format</a>. Here our data looks like this:

<pre>
Entity,Code,Year, (%)
Albania,ALB,1998,33.433434
Albania,ALB,2004,58.799999
Algeria,DZA,2004,80.733231
Algeria,DZA,2014,79.89418
Andorra,AND,2009,92.878632
Argentina,ARG,1984,78.571426
...
</pre>

<h1>Setting up our data</h1>

<p>
We have four columns with country names and codes, years, and percentages. The first thing I want to do is think about what data format I want to play with. All I'm interested in is the year, country name and happiness percentage.</p>

<p> I want to use that data in Javascript so we have to think in terms of Javascript friendly format. To do so, I want to turn the CSV data into a JSON Object.</p> 

<p>There is a multitude of services you can use</p>

<p>An array of objects very similar to the csv format.</p>
<pre>
<code class="javascript">
const data = [
	{country: 'Albania', year:'1998', happinessPercentage:33.433434},
	...
]
</code>
</pre>

<div class='pros-cons'>
	<ul class='pros'>
		<li>Not a lot of work needed to convert the data.</li>
		<li>An array if you are using arrays your chart component doesn't need to know much about your data's context.</li>
	</ul>
	<ul class='cons'>
	<li>We are using objects in the array, so the chart will need to know some context about the data it is consuming.</li>
	<li>The data is not easy to read, we can't access specific data points easily. For example, if I want to know about what the happiness score was in the United States in 1992 I have to build a specific function to do so.</li>
	</ul>
</div>
<p>An object with country names as keys.</p>
<pre>
<code class='code-rotate'>
const data = {
	Albania: [{
		year:'1998', 
		happinessPercentage:33.433434},
		{
			year: '2004'
			happinessPercentage: 58.799999
		}
		// More years
		]
	Argentina: [
		//...
	]
	//...
}
</code>
</pre>
<div class='pros-cons'>
<ul class='pros'>
	<li>The data is relatively easy to access.</li>
	<li>Each data keys is equivalent to on line</li>
</ul>
<ul>
	<li>Same problem as above with the keys in the array of entries. The chart needs to know about the `.year` and `.happinessPercentage` to draw the chart. We also need a way to tell the chart that each key is a country name. But we will see that there are some ways around it.</li>
</ul>
</div>
<p>A very explicit object.</p>
<pre>
<code>
const data = {
	'1998': ['Albania', 33.433434],
		{
			country: 'France'
			happinessPercentage: 86.799999
		}
		// ...More countries
	]
	'1999': [
		//...
	]
	//...More years
}
</code>
</pre>
<div class='pros-cons'>
<ul class='pros'>
<li>Same as above</li>
</ul>
<ul class='cons'>
<li>Similar to above. We need to somehow pass even more context to the chart because now we don't have a way to tell that the keys are years, first element of the array is a country and second a percentage.</li>
</ul>
<ul>Not as readable as the country names as keys in my opinion, this would work better if we were interested in building a map</ul>

<p>
	You can also imagine a multitude of combination of all these approaches. Here we will choose an array of arrays:
</p>
<pre>
<code>
const data = [
	['Albania', '1998', 33.433434], ...
]
</code>
</pre>

<p>
This might seem a bit impractical at first. But with no object (and object keys), we don't need any context to read our data. This means that we will be able to reuse our Line Chart in other contexts, with different data set. The only issue is that we need to pass some additional information to tell our graph what's the name our lines, yaxis and xaxis. 
</p>

<h2>Converting our data to JSON. </h2>
<p>
There are a lot of tools you can use to transform csv to json. If you want to stick to Node/Javascript you can use the npm package <mark>csvtojson</mark>. Here is the script I used:
</p>
<pre><code>
const path = require('path')
const fs = require('fs')
const csv=require('csvtojson')
csv().fromFile(path.resolve(__dirname, './share-of-people-who-say-they-are-happy.csv'))
.then(jsonObj => {
		// console.log(jsonObj);
		// jsonObj is an array of objects which looks like this:
		// { Entity: 'Hungary', Code: 'HUN', Year: '1984', '(%)': '78.451881' },
		const finalArray = []
		jsonObj.forEach(entry=>{
			finalArray.push([entry.Entity, entry.Year, entry['(%)']])
		})
		fs.writeFileSync(path.resolve(__dirname, './share-of-people-who-say-they-are-happy.json'), JSON.stringify(finalArray))
})
</code></pre>

<h1 ><a id='writing-lines'></a>Writing the lines </h1>

Alright so now we can access our data by running:
<pre><code>
const getHappinessData = () => {
	return fetch('/assets/data/share-of-people-who-say-they-are-happy.json').then(res => res.text())
}

</code></pre>

<p>You can run in your developer console: <code>getHappinessData().then(data=> console.log(data) )</code> to see the data.
</p>

<p>

</p>

<svg width='500' height='500' viewBox="0 0 100 100}">
    <!-- line chart -->
		<g class="axis x-axis">
      {#each xScale.ticks() as i}
        <g class="tick" transform="translate({xScale(i)},{height})">
          <text x="0" y="-4">{i == 0 ? "Day ":""}{i}</text>
        </g>
      {/each}
			<g class="axis y-axis" transform="translate(0,{padding.top})">
      {#each yScale.ticks(5) as tick}
        <g class="tick tick-{tick}" transform="translate(0, {yScale(tick) - padding.bottom})">
          <line x2="100%"></line>
          <text y="-4">{Number.isInteger(Math.log10(tick)) ? (tick).toLocaleString() : (log ? "": (tick).toLocaleString())}{ (tick == yScale.ticks(5)[0]) ? " ": ""}</text>
        </g>
      {/each}
		
    </g>

    </g>
		<g>
      <!-- <path fill="#cce5df" stroke="none" d="{area(data)}" /> -->
      {#each lines as line, i}
			<g>
				<path fill="none" 
				stroke={colors[i]} 
				stroke-width="4" d="{line(timeSeries)}" />
				</g>
			{/each}

					<g class="focus">
			
			<circle r=5 fill={colors[0]} cx={xScale(toolTipDataY)} cy={yScale(toolTipData.confirmed)}></circle>
			<circle r=5 fill={colors[2]} cx={xScale(toolTipDataY)} cy={yScale(toolTipData.fatalities)}></circle>
			{#if toolTipData.confirmed}
					<rect class="tooltip" width={100} height={80} x={mousePosX} y={mousePosY} rx={4} ry={4}/>
					{#each Object.keys(toolTipData) as data,i}
					<text x={mousePosX + i + 20} y={mousePosY +  i *20 +20}  class="tooltip-date">
							{data}
					</text>

					{/each}
				
			{/if}

			</g>
		</g>
		<rect 
			{width} {height}
			class="overlay" 
			on:mousemove={mousemove}
		></rect>
</svg>

<script>
const getHappinessData = () => {
	return fetch('/assets/data/share-of-people-who-say-they-are-happy.json').then(res => res.text())
}
</script>
</p>
				</div>
			</div>
		</div>
</div>
</div>
<footer class="footer">
	
	<!-- <script type="text/javascript" src='/js/bundle.js' async></script>  -->
	<script type="text/javascript" src='/js/main.js' ></script>
	<!-- <script type="text/javascript" src="/js/transitions.js" ></script> -->
	<script type="text/javascript" src='/js/history.js' ></script>

</footer>